<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Tareas</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .container {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            width: 400px;
        }

        h1 {
            font-size: 24px;
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }

        #task-form {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #task-input, #task-desc, #task-priority, #task-difficulty {
            width: 80%;
            padding: 10px;
            border: 1px solid #000000;
            border-radius: 5px;
            font-size: 16px;
            margin-bottom: 10px;
        }

        button {
            background-color: #2ba8e2;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #000000;
        }

        #task-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }

        #task-list li {
            padding: 12px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.3s ease;
        }

        #task-list li:hover {
            background-color: #f1f1f1;
        }

        .remove-task, .edit-task {
            cursor: pointer;
            font-weight: bold;
            margin-left: 10px;
            transition: color 0.3s ease;
        }

        .remove-task:hover {
            color: #d12626;
        }

        .edit-task:hover {
            color: #2ba8e2;
        }

        .task-text, .task-desc {
            display: inline-block;
            margin-left: 10px;
            font-weight: bold;
        }

        .task-desc {
            font-weight: normal;
            color: #555;
            margin-left: 20px;
        }

        .completed {
            text-decoration: line-through;
            color: #aaa;
        }

        .checkbox {
            cursor: pointer;
        }

        .task-info {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Lista de Tareas</h1>

    <!-- Formulario para añadir tareas -->
    <form id="task-form">
        <input type="text" id="task-input" placeholder="Nombre de la tarea" required>
        <textarea id="task-desc" placeholder="Descripción de la tarea" required></textarea>

        <!-- Campo para nivel de dificultad -->
        <select id="task-difficulty" required>
            <option value="">Seleccione nivel de dificultad</option>
            <option value="Baja">Baja</option>
            <option value="Media">Media</option>
            <option value="Alta">Alta</option>
        </select>

        <!-- Campo para prioridad -->
        <input type="number" id="task-priority" placeholder="Prioridad (1 a 5)" min="1" max="5" required>

        <button type="submit">Añadir</button>
    </form>

    <!-- Lista de tareas -->
    <ul id="task-list">
        <!-- Las tareas aparecerán aquí -->
    </ul>
</div>

<script>
    // Obtener elementos del DOM
    const taskForm = document.getElementById('task-form');
    const taskInput = document.getElementById('task-input');
    const taskDesc = document.getElementById('task-desc');
    const taskDifficulty = document.getElementById('task-difficulty');
    const taskPriority = document.getElementById('task-priority');
    const taskList = document.getElementById('task-list');

    // Función para cargar todas las tareas desde el backend al iniciar la página
    function cargarTareas() {
        fetch("https://cvds-app.azurewebsites.net/api/tareas")
            .then(response => response.json())
            .then(tareas => {
                tareas.forEach(tarea => {
                    agregarTareaDOM(tarea); // Agregar cada tarea al DOM
                });
            })
            .catch(error => {
                console.error("Error al cargar tareas:", error);
            });
    }

    // Función para agregar o actualizar una tarea en el DOM
    function agregarTareaDOM(tarea) {
        // Verificar si la tarea ya existe en el DOM
        let tareaExistente = document.querySelector(`[data-task-id='${tarea.id}']`);

        // Si existe, eliminarla para actualizar su estado
        if (tareaExistente) {
            tareaExistente.remove();
        }

        // Crear el nuevo elemento de lista (li) para la tarea
        const li = document.createElement('li');
        li.dataset.taskId = tarea.id;

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.classList.add('checkbox');
        checkbox.checked = tarea.completada;

        const taskInfo = document.createElement('div');
        taskInfo.classList.add('task-info');

        const taskSpan = document.createElement('span');
        taskSpan.classList.add('task-text');
        taskSpan.textContent = tarea.nombre;

        if (tarea.completada) {
            taskSpan.classList.add('completed');
        }

        const taskDescSpan = document.createElement('span');
        taskDescSpan.classList.add('task-desc');
        taskDescSpan.textContent = tarea.descripcion;

        const taskDifficultySpan = document.createElement('span');
        taskDifficultySpan.textContent = `Dificultad: ${tarea.dificultad}`;

        const taskPrioritySpan = document.createElement('span');
        taskPrioritySpan.textContent = `Prioridad: ${tarea.prioridad}`;

        const editBtn = document.createElement('span');
        editBtn.classList.add('edit-task');
        editBtn.textContent = 'Editar';

        const removeBtn = document.createElement('span');
        removeBtn.classList.add('remove-task');
        removeBtn.textContent = 'x';

        taskInfo.appendChild(taskSpan);
        taskInfo.appendChild(taskDescSpan);
        taskInfo.appendChild(taskDifficultySpan);
        taskInfo.appendChild(taskPrioritySpan);

        li.appendChild(checkbox);
        li.appendChild(taskInfo);
        li.appendChild(editBtn);
        li.appendChild(removeBtn);

        taskList.appendChild(li);

        // Event Listeners
        checkbox.addEventListener('click', () => marcarCompletada(tarea.id, checkbox.checked, taskSpan));
        removeBtn.addEventListener('click', () => eliminarTarea(tarea.id, li));
        editBtn.addEventListener('click', () => editarTarea(tarea));
    }

    // Función para marcar tarea como completada en el servidor y actualizar visualmente
    function marcarCompletada(id, completada, taskSpan) {
        fetch(`https://cvds-app.azurewebsites.net/api/tareas/${id}/completar`, {
            method: "PUT",
        })
            .then(() => {
                // Actualiza el estado visual de la tarea sin duplicarla
                if (completada) {
                    taskSpan.classList.add('completed');
                } else {
                    taskSpan.classList.remove('completed');
                }

            })
            .catch(error => {
                console.error("Error al completar tarea:", error);
            });
    }

    window.onload = cargarTareas;

    // Eliminar tarea
    function eliminarTarea(id, li) {
        fetch(`https://cvds-app.azurewebsites.net/api/tareas/${id}`, {
            method: "DELETE",
        })
            .then(() => {
                li.remove();
            })
            .catch(error => {
                console.error("Error al eliminar tarea:", error);
            });
    }

    // Editar tarea
    function editarTarea(tarea) {
        taskInput.value = tarea.nombre;
        taskDesc.value = tarea.descripcion;
        taskDifficulty.value = tarea.dificultad;
        taskPriority.value = tarea.prioridad;

        taskForm.onsubmit = (e) => {
            e.preventDefault();
            actualizarTarea(tarea.id);
        };
    }

    // Actualizar tarea
    function actualizarTarea(id) {
        const updatedTask = {
            nombre: taskInput.value.trim(),
            descripcion: taskDesc.value.trim(),
            dificultad: taskDifficulty.value,
            prioridad: taskPriority.value,
        };

        fetch(`https://cvds-app.azurewebsites.net/api/tareas/${id}/actualizar`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(updatedTask),
        })
            .then(() => {
                cargarTareas();
                taskForm.reset();
                taskForm.onsubmit = addTask; // Restaurar comportamiento original
            })
            .catch(error => {
                console.error("Error al actualizar tarea:", error);
            });
    }

    // Añadir nueva tarea
    function addTask(e) {
        e.preventDefault();

        const nuevaTarea = {
            nombre: taskInput.value.trim(),
            descripcion: taskDesc.value.trim(),
            dificultad: taskDifficulty.value,
            prioridad: taskPriority.value,
        };

        fetch("https://cvds-app.azurewebsites.net/api/tareas", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(nuevaTarea),
        })
            .then(response => response.json())
            .then(tarea => {
                agregarTareaDOM(tarea);
                taskForm.reset();
            })
            .catch(error => {
                console.error("Error al añadir tarea:", error);
            });
    }

    taskForm.onsubmit = addTask;
    cargarTareas();
</script>
</body>
</html>
